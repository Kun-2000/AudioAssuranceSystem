# AudioAssuranceSystem - 即時音訊品質保障系統

本專案為一套基於 WebRTC 與微服務架構的即時音訊品質保障系統。系統旨在透過雙軌錄音與 AI 分析的機制，自動化地驗證通話錄音的完整性與內容一致性,確保官方錄音檔沒有遺失任何對話內容。

## 目錄

1. [專案目標](#專案目標)
2. [應用場景](#應用場景)
3. [核心功能](#核心功能)
4. [系統部署與啟動](#系統部署與啟動)
5. [系統架構](#系統架構)
6. [模組結構詳解](#模組結構詳解)
7. [目前問題](#目前問題)

## 專案目標

在客服中心或任何需要通話錄音的場景中,確保錄音檔的完整性至關重要,但傳統的人工抽樣檢查耗時且效率低下。本專案旨在解決此問題,達成以下目標:

- **雙系統驗證**: 建立一個由「核心錄音系統」與「品質監控系統」組成的雙軌制流程,透過獨立的側錄檔來交叉比對,確保官方錄音的可靠性。

- **自動化分析管線**: 從通話結束、錄音歸檔到 AI 分析,建立一個無需人工干預的完整品質分析流程。

- **深度語意比對**: 利用大型語言模型 (LLM) 評估兩份錄音的轉錄稿,在「語意」層面進行內容一致性分析,超越傳統的字面比對。

- **視覺化監控與報告**: 提供即時的通話轉錄儀表板,以及包含準確率分數、差異分析與改進建議的量化歷史報告。

## 應用場景

本系統的核心應用場景是客服中心或線上通訊平台的自動化錄音品質確信 (Quality Assurance),旨在解決傳統人工抽檢錄音所面臨的覆蓋率低、反應慢及標準不一的問題。

- **確保錄音完整性**: 在金融、保險等受嚴格監管的行業,通話錄音是法律證據的一部分。本系統可自動驗證每一通電話的錄音是否完整,預防因技術問題(如網路抖動、伺服器異常)造成的內容遺漏。

- **自動化回歸測試**: 當通話系統、WebRTC 閘道或錄音模組進行版本更新時,可自動化地驗證新版本是否對錄音品質產生負面影響,確保系統變更的穩定性。

- **即時營運監控**: 透過即時轉錄儀表板,營運或品保人員可以在通話進行的當下,初步了解對話內容,無需等待通話結束後的錄音檔生成。

- **建立客觀品質指標**: 系統產出的「內容一致性分數」可作為一個客觀、可量化的 KPI,用以長期追蹤與評估錄音系統的健康狀況。

## 核心功能

- **微服務架構**: 採用前後端分離與雙後端系統的設計,將「核心通話」與「品質保障」職責解耦,提升系統的穩定性與可維護性。

- **WebRTC 即時通訊**: 提供一個基於 WebRTC 的通話介面,支援點對點的即時音訊通話。

- **前端音訊混合**: 在瀏覽器端即時將本地與遠端音訊混合,確保傳送至後端的音訊流包含雙方對話。

- **AI 驅動的分析引擎**:

  - **STT**: 整合 OpenAI Whisper 模型,進行高準確度的語音轉文字。
  - **LLM**: 使用 OpenAI GPT-4o 模型,透過精心設計的 Prompt 對兩份轉錄稿進行深度語意比對與分析。

- **雙前端管理介面**:

  - **錄音檔管理介面**: 提供官方錄音檔的搜尋、播放與下載功能。
  - **品質監控儀表板**: 提供即時通話轉錄監控與歷史分析報告的視覺化查詢介面。

- **非同步後端處理**: 後端全面採用 FastAPI 與非同步設計,確保高併發場景下的系統效能與穩定性。

## 系統部署與啟動

本專案由兩個獨立的 FastAPI 服務組成,需要分別啟動。

### 前置需求

- Python 3.8 或更高版本
- git 版本控制工具
- FFmpeg (用於音訊處理,需安裝並確保可在命令列中執行)
- Ngrok (可選,用於公開測試)

### 部署步驟

#### 步驟 1: 取得原始碼

```bash
git clone https://github.com/Kun-2000/AudioAssuranceSystem.git
cd AudioAssuranceSystem
```

#### 步驟 2: 設定並啟動系統一 (Core Internal System)

請開啟第一個終端機視窗。

```bash
# 進入系統一目錄
cd system1_core_internal

# 建立並啟用虛擬環境
python3 -m venv venv
source venv/bin/activate

# 安裝依賴套件
pip install -r requirements.txt

# 設定環境變數
cp .env.example .env

# 啟動系統一
python main.py
```

成功啟動後,系統一將運行於 `http://localhost:8004`。

#### 步驟 3: 設定並啟動系統二 (Audio Assurance System)

請開啟第二個終端機視窗。

```bash
# 進入系統二目錄
cd system2_audio_assurance

# 建立並啟用虛擬環境
python3 -m venv venv
source venv/bin/activate

# 安裝依賴套件
pip install -r requirements.txt

# 設定環境變數
cp .env.example .env
```

接著,必須編輯 `.env` 檔案,填入您的 OpenAI API 金鑰:

```
# system2_audio_assurance/.env
OPENAI_API_KEY="sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
```

```bash
# 啟動系統二
python main.py
```

成功啟動後,系統二將運行於 `http://localhost:8005`。

#### 步驟 4: 使用 Ngrok 進行遠端測試

若您需要讓不同網路環境的測試者加入通話,您可以使用 ngrok 將系統一公開。

**前置準備**: 下載並安裝 ngrok,並完成您的 authtoken 設定。

**執行 Ngrok**:
開啟第三個終端機視窗,為系統一建立通道:

```bash
ngrok http 8004
```

執行後,ngrok 會提供一個 `https://` 開頭的公開網址 (例如 `https://unique-name-1.ngrok-free.app`)。

**進行測試**:

1. 您自己先在本地瀏覽器開啟 `http://localhost:8004` 加入通話房間。
2. 將 ngrok 提供的 `https://...` 公開網址傳送給另一位測試者。
3. 測試者開啟該網址後,即可與您在同一個房間內進行通話。

**重要提示**: 為了讓系統二的監控與分析功能正常運作,啟動服務並產生 ngrok 連結的您,必須親自作為參與者加入通話。因為系統二目前是透過您本地瀏覽器 (localhost) 的連線來接收完整的對話音訊流。

#### 步驟 5: 訪問前端應用

**您的操作介面**:

- 通話介面: `http://localhost:8004`
- 品質監控儀表板: `http://localhost:8005`

**遠端測試者的介面**:

- 通話介面: `https://<您用 ngrok 產生的網址>`

## 系統架構

本系統採用雙系統的微服務架構,確保職責分離與系統穩定性。

### 運作流程 (Workflow)

1. **通話建立**: 使用者透過系統一的通話介面 (call_app) 建立 WebRTC 連線。

2. **音訊串流**: 前端將混合後的雙方音訊,透過 WebSocket 同時發送給:

   - 系統一 的 recording_service (用於官方錄音)。
   - 系統二 的 monitoring_service (用於獨立側錄)。
   - 系統二 的 realtime_transcription_service (用於即時監控)。

3. **通話結束與觸發**: 通話掛斷後,系統一完成官方錄音的歸檔,並透過 HTTP API 通知系統二,告知「通話 Session ID」與「錄音檔下載 URL」。

4. **分析協調**: 系統二的 analysis_coordinator 在確認收到「側錄檔」和「官方錄音檔 URL」後,正式觸發分析流程。

5. **AI 分析管線**: 系統二的 analysis_service:

   - 從系統一下載官方錄音檔。
   - 使用 Whisper 模型並行轉錄兩份音檔。
   - 使用 GPT-4o 模型比對兩份文字稿,產出分析結果。

6. **報告呈現**: 分析結果儲存於系統二,使用者可隨時在品質監控儀表板上查看詳細報告。

## 模組結構詳解

```
AudioAssuranceSystem/
├── system1_core_internal/              # 系統一:核心通話與錄音系統
│   ├── api/                            # FastAPI 應用與路由
│   ├── config/                         # 系統設定
│   ├── services/                       # 核心服務 (信令, 錄音, 儲存, 會話管理)
│   ├── web/                            # 系統一的前端應用
│   │   ├── call_app/                   #   - 通話介面
│   │   └── recording_management_app/   #   - 錄音檔管理介面
│   ├── .env.example                    # 環境變數範本
│   ├── main.py                         # 啟動入口
│   └── requirements.txt                # 依賴套件
│
└── system2_audio_assurance/            # 系統二:品質保障與分析系統
    ├── api/                            # FastAPI 應用與路由
    ├── config/                         # 系統設定
    ├── services/                       # 核心服務 (監控, STT, LLM, 分析協調)
    ├── web/                            # 系統二的前端應用
    │   └── quality_monitoring_app/     #   - 品質監控儀表板
    ├── .env.example                    # 環境變數範本
    ├── main.py                         # 啟動入口
    └── requirements.txt                # 依賴套件
```

## 目前問題

本專案目前仍在持續開發中,已知存在以下可改進的項目:

- **即時錄音延遲問題**

  - 目前的即時轉錄功能,為了確保語句完整性,採用了 VAD (語音活動偵測) 機制,會在使用者說話停頓後等待 0.8 秒才進行處理。

  - 加上外部 STT API 的網路與運算延遲,會導致轉錄文字出現在螢幕上有 1-3 秒的延遲,對於追求極致即時性的場景仍有優化空間。

- **尚未有音檔備份功能**

  - 所有錄音檔目前僅儲存在應用程式本地的 storage 目錄下。

  - 尚未建立自動化備份至雲端儲存(如 AWS S3, Google Cloud Storage)或其他儲存伺服器的機制,若本地磁碟損毀,將有資料遺失的風險。
